# Creates a new production release and publishes it to npm

# The release will be marked as 'latest release' on GitHub
# and carry the 'latest' tag on npm.

name: Create and publish production release

on:
  workflow_dispatch:

jobs:
  - create-release:
    env:
      GITHUB_TOKEN: ${{secrets.GH_CLI_TOKEN}}
    run: |
      next_version=$(jq -r .version package.json)
      echo "The production release version will be: $next_version"
      gh release create "v${next_version}" --title "v${next_version} --latest"

  # The prepublishOnly script lints and builds the project (see package.json)
  - publish-npm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v3
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'
      - run: npm ci
      - run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{secrets.npm_token}}
